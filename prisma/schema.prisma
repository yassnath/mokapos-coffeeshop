generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  CASHIER
  BARISTA
}

enum ShiftStatus {
  OPEN
  CLOSED
}

enum PaymentMethod {
  CASH
  CARD
  QRIS
  EWALLET
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  VOIDED
}

enum OrderStatus {
  NEW
  IN_PROGRESS
  READY
  COMPLETED
  VOIDED
  REFUNDED
}

enum ItemStatus {
  NEW
  PREPARING
  READY
}

enum RefundVoidType {
  VOID
  REFUND
}

model User {
  id             String   @id @default(cuid())
  name           String
  email          String?  @unique
  username       String?  @unique
  defaultStoreId String?
  passwordHash   String?
  pinHash        String?
  image          String?
  role           Role     @default(CASHIER)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  accounts     Account[]
  sessions     Session[]
  defaultStore Store?       @relation(fields: [defaultStoreId], references: [id], onDelete: SetNull)
  shifts       Shift[]
  orders       Order[]      @relation("CashierOrders")
  auditLogs    AuditLog[]
  refundVoids  RefundVoid[] @relation("CreatedByUser")
}

model Store {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  address           String?
  phone             String?
  taxRate           Decimal  @default(11) @db.Decimal(5, 2)
  serviceChargeRate Decimal  @default(5) @db.Decimal(5, 2)
  roundingUnit      Int      @default(100)
  currency          String   @default("IDR")
  timezone          String   @default("Asia/Jakarta")
  receiptHeader     String?
  receiptFooter     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  settings       StoreSetting?
  users          User[]
  registers      Register[]
  categories     Category[]
  products       Product[]
  modifierGroups ModifierGroup[]
  customers      Customer[]
  orders         Order[]
  shifts         Shift[]
  auditLogs      AuditLog[]
}

model StoreSetting {
  id              String   @id @default(cuid())
  storeId         String   @unique
  printerName     String?
  receiptCopies   Int      @default(1)
  allowTips       Boolean  @default(true)
  permissionsJson Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

model Register {
  id        String   @id @default(cuid())
  storeId   String
  name      String
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store  Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  shifts Shift[]
  orders Order[]

  @@unique([storeId, name])
  @@index([storeId])
}

model Shift {
  id           String      @id @default(cuid())
  storeId      String
  registerId   String
  userId       String
  status       ShiftStatus @default(OPEN)
  openedAt     DateTime    @default(now())
  closedAt     DateTime?
  openingCash  Decimal     @default(0) @db.Decimal(12, 2)
  cashIn       Decimal     @default(0) @db.Decimal(12, 2)
  cashOut      Decimal     @default(0) @db.Decimal(12, 2)
  expectedCash Decimal?    @db.Decimal(12, 2)
  actualCash   Decimal?    @db.Decimal(12, 2)
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  register Register  @relation(fields: [registerId], references: [id], onDelete: Restrict)
  user     User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  orders   Order[]
  payments Payment[]

  @@index([storeId, status])
  @@index([registerId, status])
}

model Customer {
  id            String   @id @default(cuid())
  storeId       String
  name          String
  phone         String?
  email         String?
  notes         String?
  loyaltyPoints Int      @default(0)
  isWalkIn      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  store  Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([storeId, name])
}

model Category {
  id        String   @id @default(cuid())
  storeId   String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([storeId, name])
  @@index([storeId, sortOrder])
}

model Product {
  id          String   @id @default(cuid())
  storeId     String
  categoryId  String?
  name        String
  sku         String?
  description String?
  basePrice   Decimal  @db.Decimal(12, 2)
  costPrice   Decimal  @default(0) @db.Decimal(12, 2)
  stock       Int      @default(100)
  imageUrl    String?
  isFavorite  Boolean  @default(false)
  isAvailable Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store          Store                  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category       Category?              @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  modifierGroups ProductModifierGroup[]
  orderItems     OrderItem[]

  @@unique([storeId, name])
  @@index([storeId, categoryId, isAvailable])
}

model ModifierGroup {
  id        String   @id @default(cuid())
  storeId   String
  name      String
  required  Boolean  @default(false)
  minSelect Int      @default(0)
  maxSelect Int      @default(1)
  isMulti   Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store    Store                  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  options  ModifierOption[]
  products ProductModifierGroup[]

  @@unique([storeId, name])
  @@index([storeId, sortOrder])
}

model ModifierOption {
  id          String   @id @default(cuid())
  groupId     String
  name        String
  priceDelta  Decimal  @default(0) @db.Decimal(12, 2)
  isAvailable Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  group              ModifierGroup       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  orderItemModifiers OrderItemModifier[]

  @@unique([groupId, name])
  @@index([groupId, sortOrder])
}

model ProductModifierGroup {
  productId String
  groupId   String
  sortOrder Int    @default(0)

  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@id([productId, groupId])
  @@index([groupId])
}

model Order {
  id                  String      @id @default(cuid())
  orderNumber         String      @unique
  storeId             String
  registerId          String
  shiftId             String?
  cashierId           String?
  customerId          String?
  status              OrderStatus @default(NEW)
  subtotal            Decimal     @db.Decimal(12, 2)
  itemDiscount        Decimal     @default(0) @db.Decimal(12, 2)
  orderDiscount       Decimal     @default(0) @db.Decimal(12, 2)
  taxAmount           Decimal     @default(0) @db.Decimal(12, 2)
  serviceChargeAmount Decimal     @default(0) @db.Decimal(12, 2)
  tipAmount           Decimal     @default(0) @db.Decimal(12, 2)
  roundingAmount      Decimal     @default(0) @db.Decimal(12, 2)
  totalAmount         Decimal     @db.Decimal(12, 2)
  notes               String?
  placedAt            DateTime    @default(now())
  readyAt             DateTime?
  completedAt         DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  register    Register     @relation(fields: [registerId], references: [id], onDelete: Restrict)
  shift       Shift?       @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  cashier     User?        @relation("CashierOrders", fields: [cashierId], references: [id], onDelete: SetNull)
  customer    Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items       OrderItem[]
  payments    Payment[]
  refundVoids RefundVoid[]
  auditLogs   AuditLog[]

  @@index([storeId, status, placedAt])
  @@index([registerId, placedAt])
}

model OrderItem {
  id             String     @id @default(cuid())
  orderId        String
  productId      String?
  productName    String
  unitPrice      Decimal    @db.Decimal(12, 2)
  quantity       Int
  discountAmount Decimal    @default(0) @db.Decimal(12, 2)
  lineTotal      Decimal    @db.Decimal(12, 2)
  note           String?
  preparedQty    Int        @default(0)
  itemStatus     ItemStatus @default(NEW)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  order     Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product?            @relation(fields: [productId], references: [id], onDelete: SetNull)
  modifiers OrderItemModifier[]

  @@index([orderId])
}

model OrderItemModifier {
  id                 String   @id @default(cuid())
  orderItemId        String
  optionId           String?
  modifierGroupName  String
  modifierOptionName String
  priceDelta         Decimal  @default(0) @db.Decimal(12, 2)
  createdAt          DateTime @default(now())

  orderItem OrderItem       @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  option    ModifierOption? @relation(fields: [optionId], references: [id], onDelete: SetNull)

  @@index([orderItemId])
}

model Payment {
  id        String        @id @default(cuid())
  orderId   String
  shiftId   String?
  method    PaymentMethod
  amount    Decimal       @db.Decimal(12, 2)
  status    PaymentStatus @default(PAID)
  reference String?
  metadata  Json?
  paidAt    DateTime      @default(now())
  createdAt DateTime      @default(now())

  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shift       Shift?       @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  refundVoids RefundVoid[]

  @@index([orderId, method])
}

model RefundVoid {
  id          String         @id @default(cuid())
  orderId     String
  paymentId   String?
  type        RefundVoidType
  amount      Decimal        @db.Decimal(12, 2)
  reason      String
  createdById String
  createdAt   DateTime       @default(now())

  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  createdBy User     @relation("CreatedByUser", fields: [createdById], references: [id], onDelete: Restrict)

  @@index([orderId, type])
}

model AuditLog {
  id        String   @id @default(cuid())
  storeId   String
  userId    String?
  orderId   String?
  action    String
  entity    String
  entityId  String
  message   String?
  metadata  Json?
  createdAt DateTime @default(now())

  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)
  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([storeId, createdAt])
  @@index([entity, entityId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
